<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 오페라 인증 대시보드</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard 폰트 로드 -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fcf8f3;
        }
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .btn-approve {
            background-color: #10b981; /* green-500 */
            box-shadow: 0 4px 0 0 #059669; /* green-600 */
            transition: all 0.1s ease;
        }
        .btn-approve:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #059669;
        }
        .btn-reject {
            background-color: #ef4444; /* red-500 */
            box-shadow: 0 4px 0 0 #dc2626; /* red-600 */
            transition: all 0.1s ease;
        }
        .btn-reject:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 0 #dc2626;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="admin-app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-red-700 mb-2">
                👨‍💻 오페라 빙고 관리자 대시보드
            </h1>
            <p class="text-lg text-gray-500">
                학생들의 인증 요청을 승인/거절합니다.
            </p>
        </header>

        <!-- 관리자 로그인 섹션 -->
        <div id="login-section" class="card bg-white p-8 rounded-xl max-w-sm mx-auto shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">관리자 로그인</h2>
            <input type="password" id="admin-key" placeholder="관리자 비밀번호 입력"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-400 text-lg mb-4">
            <button id="login-button" class="w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200">
                로그인
            </button>
            <p id="login-message" class="mt-3 text-red-500 text-center"></p>
        </div>

        <!-- 인증 요청 리스트 섹션 -->
        <div id="dashboard-section" class="hidden">
            <h2 class="text-3xl font-extrabold text-gray-700 mb-6">
                실시간 인증 요청 목록 (<span id="pending-count">0</span>건 대기 중)
            </h2>
            
            <div id="submissions-list" class="space-y-4">
                <p class="text-center text-gray-500">데이터 로드 중...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase 초기화 및 설정 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        const ADMIN_KEY = 'admin1234'; 
        let isAdminLoggedIn = false;
        // 컬렉션 경로 변경: 'submissions_opera'
        const SUBMISSIONS_COLLECTION_PATH = `artifacts/${appId}/public/submissions_opera`;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 익명 사용자 인증 (Firestore 사용을 위함)
            window.addEventListener('DOMContentLoaded', () => {
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('login-message').textContent = '❌ Firebase 연결 오류. 콘솔을 확인하세요.';
        }

        // --- DOM 요소 ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const adminKeyInput = document.getElementById('admin-key');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        const submissionsList = document.getElementById('submissions-list');
        const pendingCountDisplay = document.getElementById('pending-count');


        /**
         * 관리자 로그인 처리
         */
        loginButton.addEventListener('click', () => {
            if (adminKeyInput.value === ADMIN_KEY) {
                isAdminLoggedIn = true;
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                loginMessage.textContent = '';
                listenForSubmissions(); // 로그인 성공 시 리스너 시작
            } else {
                loginMessage.textContent = '비밀번호가 일치하지 않습니다.';
            }
        });


        /**
         * 실시간 인증 요청 리스너 설정
         */
        function listenForSubmissions() {
            if (!isAdminLoggedIn) return;

            const submissionsRef = collection(db, SUBMISSIONS_COLLECTION_PATH);
            
            // 모든 요청을 실시간으로 가져옵니다.
            onSnapshot(submissionsRef, (snapshot) => {
                renderSubmissions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.error("Dashboard listener error:", error);
                // 오류 발생 시 대시보드 메시지 업데이트
                submissionsList.innerHTML = `<p class="text-center text-red-500">데이터 로드 중 오류 발생: ${error.message}</p>`;
            });
        }
        
        /**
         * 요청 목록을 HTML로 렌더링합니다.
         */
        function renderSubmissions(submissions) {
            submissionsList.innerHTML = '';
            let pendingCount = 0;

            if (submissions.length === 0) {
                submissionsList.innerHTML = `<p class="text-center text-gray-500 py-8">현재 접수된 인증 요청이 없습니다.</p>`;
                pendingCountDisplay.textContent = 0;
                return;
            }

            submissions.sort((a, b) => {
                // Pending 요청을 최상단에 표시
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                // 요청 시간(requestTime)이 최신순으로 정렬
                return b.requestTime?.toDate().getTime() - a.requestTime?.toDate().getTime();
            });


            submissions.forEach(submission => {
                const isPending = submission.status === 'pending';
                if (isPending) pendingCount++;
                
                // 사용자 이름 (userName) 표시 추가
                const userNameDisplay = submission.userName || '이름 없음';

                const statusClass = isPending ? 'bg-orange-100 border-orange-400' : 
                                    submission.status === 'approved' ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400';
                const statusText = isPending ? '⏳ 대기 중' : 
                                   submission.status === 'approved' ? '✅ 승인됨' : '❌ 거절됨';
                
                const timeString = submission.requestTime ? 
                    new Date(submission.requestTime.seconds * 1000).toLocaleString('ko-KR', { timeStyle: 'short', dateStyle: 'short' }) : 'N/A';

                const submissionItem = document.createElement('div');
                submissionItem.className = `card p-5 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center ${statusClass} border-l-4`;
                submissionItem.innerHTML = `
                    <div class="flex-1 mb-4 md:mb-0">
                        <div class="flex items-baseline space-x-2">
                           <h3 class="text-2xl font-bold text-gray-900">${userNameDisplay}</h3>
                           <p class="text-xs font-semibold text-gray-500">(${timeString})</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">미션: ${submission.topic} / ID: <span class="font-mono text-gray-400 text-xs">${submission.userId}</span></p>
                        <p class="text-sm italic text-gray-700 mt-2">${submission.question}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${isPending ? 'bg-orange-500 text-white' : 'bg-gray-300 text-gray-700'}">${statusText}</span>
                        ${isPending ? `
                            <button data-id="${submission.id}" data-action="approve" class="btn-approve px-4 py-2 text-white font-bold rounded-lg text-sm">승인</button>
                            <button data-id="${submission.id}" data-action="reject" class="btn-reject px-4 py-2 text-white font-bold rounded-lg text-sm">거절</button>
                        ` : ''}
                    </div>
                `;
                submissionsList.appendChild(submissionItem);
            });
            
            pendingCountDisplay.textContent = pendingCount;

            // 이벤트 위임으로 버튼 핸들링
            submissionsList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    if (docId && action) {
                        handleApproval(docId, action);
                    }
                });
            });
        }

        /**
         * 승인/거절 처리
         */
        async function handleApproval(docId, action) {
            if (!isAdminLoggedIn) return;

            const newStatus = action === 'approve' ? 'approved' : 'rejected';
            try {
                const submissionRef = doc(db, SUBMISSIONS_COLLECTION_PATH, docId);
                await updateDoc(submissionRef, { status: newStatus });
                console.log(`Mission ${docId} ${newStatus} successfully.`);
            } catch (error) {
                console.error(`Error updating mission status to ${newStatus}:`, error);
                alert(`처리 중 오류가 발생했습니다: ${error.message}`);
            }
        }
    </script>
</body>
</html>
