<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ì˜¤í˜ë¼ ì¸ì¦ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard í°íŠ¸ ë¡œë“œ -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fcf8f3;
        }
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .btn-approve {
            background-color: #10b981; /* green-500 */
            box-shadow: 0 4px 0 0 #059669; /* green-600 */
            transition: all 0.1s ease;
        }
        .btn-approve:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #059669;
        }
        .btn-reject {
            background-color: #ef4444; /* red-500 */
            box-shadow: 0 4px 0 0 #dc2626; /* red-600 */
            transition: all 0.1s ease;
        }
        .btn-reject:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 0 #dc2626;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="admin-app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-red-700 mb-2">
                ğŸ‘¨â€ğŸ’» ì˜¤í˜ë¼ ë¹™ê³  ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
            </h1>
            <p class="text-lg text-gray-500">
                í•™ìƒë“¤ì˜ ì¸ì¦ ìš”ì²­ì„ ìŠ¹ì¸/ê±°ì ˆí•©ë‹ˆë‹¤.
            </p>
        </header>

        <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div id="login-section" class="card bg-white p-8 rounded-xl max-w-sm mx-auto shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <input type="password" id="admin-key" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-400 text-lg mb-4">
            <button id="login-button" class="w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200">
                ë¡œê·¸ì¸
            </button>
            <p id="login-message" class="mt-3 text-red-500 text-center"></p>
        </div>

        <!-- ì¸ì¦ ìš”ì²­ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div id="dashboard-section" class="hidden">
            <h2 class="text-3xl font-extrabold text-gray-700 mb-6">
                ì‹¤ì‹œê°„ ì¸ì¦ ìš”ì²­ ëª©ë¡ (<span id="pending-count">0</span>ê±´ ëŒ€ê¸° ì¤‘)
            </h2>
            
            <div id="submissions-list" class="space-y-4">
                <p class="text-center text-gray-500">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase ì´ˆê¸°í™” ë° ì„¤ì • (ë¡œì»¬ í™˜ê²½ ëŒ€ì‘) ---
        // Canvas ì™¸ í™˜ê²½ì—ì„œ ì‹¤í–‰ë  ê²½ìš°, ì•„ë˜ì™€ ê°™ì´ ë”ë¯¸ ê°’ ì‚¬ìš©ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'local-debug-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        const ADMIN_KEY = 'admin1234'; 
        let isAdminLoggedIn = false;
        // ì»¬ë ‰ì…˜ ê²½ë¡œ ë³€ê²½: 'submissions_opera'
        const SUBMISSIONS_COLLECTION_PATH = `artifacts/${appId}/public/submissions_opera`;

        try {
            // ë¡œì»¬ ë””ë²„ê¹… í™˜ê²½(firebaseConfigê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°)ì¸ì§€ í™•ì¸
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("--- LOCAL ENVIRONMENT WARNING ---");
                console.error("Firebase config is empty. This code is designed to run in a controlled environment.");
                console.error("The dashboard will function visually, but real-time data connection will fail.");
                document.getElementById('login-message').textContent = 'âš ï¸ ë¡œì»¬ í™˜ê²½ ì‹¤í–‰ ì¤‘: Firebase ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨. ì‹¤ì œ ë°°í¬ í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.';
                // ì—¬ê¸°ì„œ Firebase ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆë›°ì–´ ReferenceError ë°©ì§€
            } else {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ìµëª… ì‚¬ìš©ì ì¸ì¦ (Firestore ì‚¬ìš©ì„ ìœ„í•¨)
                window.addEventListener('DOMContentLoaded', () => {
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                });
            }

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('login-message').textContent = 'âŒ Firebase ì—°ê²° ì˜¤ë¥˜. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
        }

        // --- DOM ìš”ì†Œ ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const adminKeyInput = document.getElementById('admin-key');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        const submissionsList = document.getElementById('submissions-list');
        const pendingCountDisplay = document.getElementById('pending-count');


        /**
         * ê´€ë¦¬ì ë¡œê·¸ì¸ ì²˜ë¦¬
         */
        loginButton.addEventListener('click', () => {
            if (adminKeyInput.value === ADMIN_KEY) {
                isAdminLoggedIn = true;
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                loginMessage.textContent = '';
                
                // ë¡œì»¬ í™˜ê²½ì¼ ê²½ìš° ë”ë¯¸ ë°ì´í„° ë Œë”ë§
                if (!db) { 
                    renderDummySubmissions();
                } else {
                    listenForSubmissions(); // Firebase í™œì„±í™” ì‹œ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                }
            } else {
                loginMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
        });

        /**
         * ë¡œì»¬ í™˜ê²½ ë””ë²„ê¹…ìš© ë”ë¯¸ ë°ì´í„° ë Œë”ë§
         */
        function renderDummySubmissions() {
             const dummySubmissions = [
                { id: 'dummy_1', userName: 'ê¹€ì² ìˆ˜', topic: 'ğŸ“¸ ìœ ëª… ì˜¤í˜ë¼ ì¸ì¦', question: 'ì˜¤í˜ë¼ ì‘í’ˆ ì¤‘ í•˜ë‚˜ë¥¼ ì„¤ëª…í•˜ì—¬ ì¸ì¦ ìš”ì²­', status: 'pending', requestTime: { seconds: Date.now() / 1000 - 600 } },
                { id: 'dummy_2', userName: 'íŒ€ ë¹„ë°œë””', topic: 'ğŸ“¸ ìœ ëª… ì˜¤í˜ë¼ ì¸ì¦', question: 'ì˜¤í˜ë¼ ì‘í’ˆ ì¤‘ í•˜ë‚˜ë¥¼ ì„¤ëª…í•˜ì—¬ ì¸ì¦ ìš”ì²­', status: 'approved', requestTime: { seconds: Date.now() / 1000 - 1200 } }
            ];
            submissionsList.innerHTML = `<p class="text-center text-red-600 font-bold py-4">Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ë”ë¯¸ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>`;
            renderSubmissions(dummySubmissions);
        }

        /**
         * ì‹¤ì‹œê°„ ì¸ì¦ ìš”ì²­ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         */
        function listenForSubmissions() {
            if (!isAdminLoggedIn || !db) return; // dbê°€ ì—†ìœ¼ë©´ Firebase ê¸°ëŠ¥ ì‹¤í–‰ ì•ˆí•¨

            const submissionsRef = collection(db, SUBMISSIONS_COLLECTION_PATH);
            
            // ëª¨ë“  ìš”ì²­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            onSnapshot(submissionsRef, (snapshot) => {
                renderSubmissions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.error("Dashboard listener error:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ì‹œë³´ë“œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                submissionsList.innerHTML = `<p class="text-center text-red-500">ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            });
        }
        
        /**
         * ìš”ì²­ ëª©ë¡ì„ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderSubmissions(submissions) {
            submissionsList.innerHTML = '';
            let pendingCount = 0;

            if (submissions.length === 0) {
                submissionsList.innerHTML = `<p class="text-center text-gray-500 py-8">í˜„ì¬ ì ‘ìˆ˜ëœ ì¸ì¦ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                pendingCountDisplay.textContent = 0;
                return;
            }

            submissions.sort((a, b) => {
                // Pending ìš”ì²­ì„ ìµœìƒë‹¨ì— í‘œì‹œ
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                // ìš”ì²­ ì‹œê°„(requestTime)ì´ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                return b.requestTime?.seconds - a.requestTime?.seconds; // Firestore Timestamp ì²˜ë¦¬
            });


            submissions.forEach(submission => {
                const isPending = submission.status === 'pending';
                if (isPending) pendingCount++;
                
                // ì‚¬ìš©ì ì´ë¦„ (userName) í‘œì‹œ ì¶”ê°€
                const userNameDisplay = submission.userName || 'ì´ë¦„ ì—†ìŒ';

                const statusClass = isPending ? 'bg-orange-100 border-orange-400' : 
                                    submission.status === 'approved' ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400';
                const statusText = isPending ? 'â³ ëŒ€ê¸° ì¤‘' : 
                                   submission.status === 'approved' ? 'âœ… ìŠ¹ì¸ë¨' : 'âŒ ê±°ì ˆë¨';
                
                const requestTime = submission.requestTime;
                let timeString = 'N/A';

                if (requestTime && typeof requestTime.toDate === 'function') {
                    // Firestore Timestamp ê°ì²´ì¸ ê²½ìš°
                    timeString = requestTime.toDate().toLocaleString('ko-KR', { timeStyle: 'short', dateStyle: 'short' });
                } else if (typeof requestTime === 'object' && requestTime.seconds) {
                    // ë”ë¯¸ ë°ì´í„°ì˜ ê²½ìš°
                    timeString = new Date(requestTime.seconds * 1000).toLocaleString('ko-KR', { timeStyle: 'short', dateStyle: 'short' });
                }

                const submissionItem = document.createElement('div');
                submissionItem.className = `card p-5 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center ${statusClass} border-l-4`;
                submissionItem.innerHTML = `
                    <div class="flex-1 mb-4 md:mb-0">
                        <div class="flex items-baseline space-x-2">
                           <h3 class="text-2xl font-bold text-gray-900">${userNameDisplay}</h3>
                           <p class="text-xs font-semibold text-gray-500">(${timeString})</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">ë¯¸ì…˜: ${submission.topic} / ID: <span class="font-mono text-gray-400 text-xs">${submission.userId || 'N/A'}</span></p>
                        <p class="text-sm italic text-gray-700 mt-2">${submission.question}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${isPending ? 'bg-orange-500 text-white' : 'bg-gray-300 text-gray-700'}">${statusText}</span>
                        ${isPending ? `
                            <button data-id="${submission.id}" data-action="approve" class="btn-approve px-4 py-2 text-white font-bold rounded-lg text-sm" ${!db ? 'disabled title="Firebase ì—°ê²° í•„ìš”"' : ''}>ìŠ¹ì¸</button>
                            <button data-id="${submission.id}" data-action="reject" class="btn-reject px-4 py-2 text-white font-bold rounded-lg text-sm" ${!db ? 'disabled title="Firebase ì—°ê²° í•„ìš”"' : ''}>ê±°ì ˆ</button>
                        ` : ''}
                    </div>
                `;
                submissionsList.appendChild(submissionItem);
            });
            
            pendingCountDisplay.textContent = pendingCount;

            // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë²„íŠ¼ í•¸ë“¤ë§
            submissionsList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    if (docId && action) {
                        handleApproval(docId, action);
                    }
                });
            });
        }

        /**
         * ìŠ¹ì¸/ê±°ì ˆ ì²˜ë¦¬
         */
        async function handleApproval(docId, action) {
            if (!isAdminLoggedIn || !db) {
                 alert('âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ìŠ¹ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                 return;
            }

            const newStatus = action === 'approve' ? 'approved' : 'rejected';
            try {
                const submissionRef = doc(db, SUBMISSIONS_COLLECTION_PATH, docId);
                await updateDoc(submissionRef, { status: newStatus });
                console.log(`Mission ${docId} ${newStatus} successfully.`);
            } catch (error) {
                console.error(`Error updating mission status to ${newStatus}:`, error);
                alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
    </script>
</body>
</html>
