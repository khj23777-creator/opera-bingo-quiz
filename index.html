<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고등 오페라 빙고 학습 (3x3)</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard 폰트 로드 (교육용으로 인기, 고가독성) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fcf8f3; /* 오페라 배경색 */
        }
        .app-container {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0b4b4; 
            background-color: #fcfcfc;
        }
        .bingo-grid {
            grid-template-columns: repeat(3, 1fr); /* 3x3 그리드 */
            transform: perspective(1000px) rotateX(1deg);
        }
        .bingo-cell {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-height: 120px;
            border-radius: 12px;
            border: 2px solid #ccc;
            word-break: keep-all; 
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
        }
        .bingo-cell:not(.bg-green-100):hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .bingo-cell.bg-green-100 {
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.15), 0 0 0 4px #4ade80;
            background: linear-gradient(145deg, #d4edda, #c6e9d2);
            transform: none;
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #ffcc00; 
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }
        .action-panel-active {
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3); /* 붉은색 계열 강조 */
            transform: translateY(-5px);
            border-color: #b91c1c;
        }
        #submit-answer, #submit-action, #reset-game {
            transform: translateY(0);
            box-shadow: 0 4px 0 0 #991b1b; /* 진한 붉은색 */
            transition: all 0.1s ease;
        }
        #submit-answer:active, #submit-action:active, #reset-game:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 0 #991b1b;
        }
        #submit-answer:disabled, #submit-action:disabled {
            box-shadow: none;
        }
        /* 인증 대기 중 셀 스타일 */
        .bingo-cell.status-pending {
            background-color: #ffeecf;
            border-color: #fca5a5;
            color: #d97706;
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(251, 146, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-xl mx-auto app-container rounded-2xl p-6 md:p-10 border-t-8 border-red-700">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-red-700 mb-2">
                🎭 오페라 핵심 개념<br> 3x3 빙고 퀴즈
            </h1>
            <p class="text-lg text-gray-600">
                고등학교 음악 수업 (오페라의 이해)
            </p>
        </header>

        <!-- 사용자 이름 입력 및 상태 메시지 -->
        <div class="mb-4">
            <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-1">팀/학생 이름 입력 (필수)</label>
            <input type="text" id="user-name-input" placeholder="이름 또는 팀명을 입력하세요"
                   class="w-full p-2 border-2 border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-base"
                   oninput="localStorage.setItem('bingo_user_name_opera', this.value);">
        </div>
        
        <div id="status-message" class="text-center mb-6 h-10">
            <p class="text-xl font-semibold text-gray-700">빙고판을 완성해 보세요! 사용자 ID: <span id="user-id-display" class="font-mono text-sm text-gray-500"></span></p>
        </div>

        <!-- 빙고 그리드 -->
        <div id="bingo-grid" class="bingo-grid grid gap-3 md:gap-4 w-full aspect-square">
            <!-- Cell content will be generated by JavaScript -->
        </div>

        <!-- 질문/액션 패널 -->
        <div id="action-panel" class="mt-8 bg-[#FDF8F8] p-4 md:p-6 rounded-xl border border-gray-200 transition duration-300">
            <h2 class="text-2xl font-extrabold text-red-700 mb-2" id="current-question-title">
                ✅ 미션 선택 대기 중
            </h2>
            <p class="text-lg text-gray-700 mb-4" id="current-question-text">
                빙고판의 문제를 터치하여 미션을 시작해 주세요.
            </p>

            <div id="input-container" class="flex flex-col sm:flex-row gap-3">
                <!-- 일반 정답 입력 UI (기본) -->
                <input type="text" id="answer-input" placeholder="정답을 입력하세요 (예: 아리아)"
                       class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-500 text-lg disabled:bg-gray-100"
                       aria-label="정답 입력 필드">
                <button id="submit-answer"
                        class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    정답 확인
                </button>
                
                <!-- 인증 미션 전용 UI (숨김) -->
                <button id="submit-action"
                        class="hidden w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    📸 유명 오페라 인증 요청 (관리자 확인 필요)
                </button>
            </div>
            
            <button id="reset-game"
                    class="mt-4 w-full px-6 py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-200">
                게임 재시작
            </button>
        </div>
    </div>

    <!-- 빙고 승리 모달 -->
    <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full animate-in zoom-in duration-500">
            <h3 class="text-4xl font-extrabold text-green-600 mb-4">🎉 빙고 성공! 🏆</h3>
            <p class="text-xl text-gray-700 mb-6">
                오페라 퀴즈 빙고를 완성했어요! 훌륭합니다.
            </p>
            <button id="close-modal" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200">
                닫기
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase 초기화 및 설정 (로컬 환경 대응) ---
        // Canvas 외 환경에서 실행될 경우, 아래와 같이 더미 값 사용을 시도합니다.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'local-debug-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = '';
        const GRID_SIZE = 3;

        try {
            // 로컬 디버깅 환경(firebaseConfig가 비어있는 경우)인지 확인
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("--- LOCAL ENVIRONMENT WARNING (Student App) ---");
                console.error("Firebase config is empty. Bingo progress will NOT be saved/shared.");
                document.getElementById('status-message').querySelector('p').textContent = '⚠️ 로컬 환경 실행 중. Firebase 연결이 필요합니다.';
                // Firebase 초기화를 건너뛰고 기능 비활성화 (db, auth는 undefined 상태 유지)
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            }
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('status-message').querySelector('p').textContent = '❌ Firebase 연결 오류. 콘솔을 확인하세요.';
        }

        // --- DOM 요소 변수 선언 ---
        let gridElement, statusMessage, actionPanel, inputContainer, inputElement, submitButton, submitActionButton, currentQuestionTitle, currentQuestionText, winModal, closeModalButton, resetButton, userNameInput;

        // --- DOM 요소 할당 함수 (DOMContentLoaded 이후 호출) ---
        function initializeDOMReferences() {
            gridElement = document.getElementById('bingo-grid');
            statusMessage = document.getElementById('status-message').querySelector('p');
            actionPanel = document.getElementById('action-panel');
            inputContainer = document.getElementById('input-container');
            inputElement = document.getElementById('answer-input');
            submitButton = document.getElementById('submit-answer');
            submitActionButton = document.getElementById('submit-action');
            currentQuestionTitle = document.getElementById('current-question-title');
            currentQuestionText = document.getElementById('current-question-text');
            winModal = document.getElementById('win-modal');
            closeModalButton = document.getElementById('close-modal');
            resetButton = document.getElementById('reset-game');
            userNameInput = document.getElementById('user-name-input');
            
            // 저장된 이름 로드
            const savedName = localStorage.getItem('bingo_user_name_opera');
            if (savedName) {
                userNameInput.value = savedName;
            }
        }

        /**
         * Firebase 인증 및 데이터 리스너 설정
         */
        async function setupFirebaseAndListen() {
            // Firebase가 초기화되지 않았으면, 보드만 생성하고 종료
            if (!db) {
                initializeNewBoard();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    await loadOrCreateBoard();
                    listenForSubmissions(); // 실시간 상태 리스너 시작
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        document.getElementById('status-message').querySelector('p').textContent = '❌ 인증 오류 발생.';
                    }
                }
            });
        }
        
        // --- 게임 데이터 정의 및 상태 관리 ---

        const BINGO_ITEMS = [
            { topic: "주요 독창", question: "오페라에서 감정을 폭발시키며 부르는, 기교를 중시한 '주요 독창곡'은? (이탈리아어)", answer: ["아리아"], isActionMission: false },
            { topic: "오페라 대본", question: "오페라의 내용을 담고 있는 '가사 대본'을 뜻하는 이탈리아어는?", answer: ["리브레토"], isActionMission: false },
            { topic: "오페라의 서곡", question: "오케스트라가 연주하는 오페라 시작 전의 '서곡'은?", answer: ["오버추어"], isActionMission: false },
            { topic: "극 진행 대화", question: "극의 줄거리 진행을 위해 대화처럼 노래하는 부분(선율이 단순함)은?", answer: ["레치타티보"], isActionMission: false },
            
            // 중앙 보너스 (Index 4)
            { topic: "🌟 보너스 찬스 🌟", question: "🌟 보너스 찬스 🌟", answer: ["보너스"], isFilled: true, isActionMission: false }, 
            
            { topic: "남성 최고 음역", question: "오페라에서 가장 높은 음역대를 맡으며, 주로 영웅이나 주인공 역할을 하는 남성 가수는?", answer: ["테너"], isActionMission: false },
            { topic: "군중 합창", question: "오페라에서 배경을 설명하거나 군중의 감정을 표현하는 '합창단'은?", answer: ["코러스", "합창"], isActionMission: false },
            
            // 미션: 오페라 감상 인증 (액션 미션)
            { topic: "📸 유명 오페라 인증", question: "수업에서 배운 유명 오페라 작품 중 하나를 선택하고, 가장 좋아하는 장면이나 등장인물을 설명하여 인증 요청 버튼을 누르세요. (예: '카르멘'의 투우사)", answer: ["인증"], isActionMission: true }, 
            
            { topic: "오페라의 탄생국", question: "16세기 말~17세기 초, 오페라가 처음 탄생한 유럽의 나라는?", answer: ["이탈리아"], isActionMission: false }
        ];

        let board = [];
        let selectedIndex = -1;
        let submissionStates = {}; 


        /**
         * Firestore에 저장된 사용자 보드를 로드하거나 새로 생성합니다.
         */
        async function loadOrCreateBoard() {
            // Firebase가 초기화되지 않았다면 새 보드 생성 후 종료
            if (!db) {
                initializeNewBoard();
                return;
            }
            if (!userId) return;

            // 컬렉션 경로 변경: 'current_board_opera'
            const boardRef = doc(db, `artifacts/${appId}/users/${userId}/bingo_data`, 'current_board_opera');
            const dataSnapshot = await getDoc(boardRef);

            if (dataSnapshot.exists()) {
                board = JSON.parse(dataSnapshot.data().state);
                statusMessage.textContent = '저장된 빙고판을 로드했습니다.';
            } else {
                initializeNewBoard();
            }
            renderBoard();
        }

        /**
         * 새로운 빙고 보드를 생성합니다.
         */
        function initializeNewBoard() {
            let shuffledItems = shuffleArray([...BINGO_ITEMS]);
            
            board = [];
            for (let i = 0; i < 9; i++) {
                const item = shuffledItems[i];
                board.push({ ...item, isFilled: item.topic.includes('보너스') ? true : false, submissionStatus: null, id: crypto.randomUUID() });
            }
            saveBoardToFirestore();
            statusMessage.textContent = db ? '새로운 빙고판이 생성되었습니다.' : '⚠️ 로컬 보드가 생성되었습니다. (저장 불가)';
        }
        
        /**
         * 현재 보드 상태를 Firestore에 저장합니다.
         */
        async function saveBoardToFirestore() {
            if (!db) return; // Firebase 연결이 없으면 저장하지 않음
            if (!userId) return;
            try {
                // 컬렉션 경로 변경: 'current_board_opera'
                const boardRef = doc(db, `artifacts/${appId}/users/${userId}/bingo_data`, 'current_board_opera');
                await setDoc(boardRef, {
                    state: JSON.stringify(board),
                    updatedAt: new Date(),
                    userId: userId
                });
            } catch (error) {
                console.error("Failed to save board:", error);
                statusMessage.textContent = '❌ 빙고판 저장 실패!';
            }
        }

        /**
         * 실시간 인증 상태 리스너 설정 (관리자 승인 확인용)
         */
        function listenForSubmissions() {
            if (!db) return; // Firebase 연결이 없으면 리스너 작동 안함
            if (!userId) return;
            // 컬렉션 경로 변경: 'submissions_opera'
            const submissionsRef = collection(db, `artifacts/${appId}/public/submissions_opera`);
            const userQuery = query(submissionsRef, where("userId", "==", userId));

            onSnapshot(userQuery, (snapshot) => {
                let updated = false;
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const missionIndex = data.missionIndex;
                    
                    submissionStates[missionIndex] = data.status; // 상태 업데이트

                    // 상태가 'approved'로 변경되었고, 아직 빙고판에 반영되지 않았다면 반영
                    if (data.status === 'approved' && !board[missionIndex].isFilled) {
                        board[missionIndex].isFilled = true;
                        statusMessage.textContent = `🎉 관리자가 미션 #${missionIndex + 1}을 승인했습니다!`;
                        updated = true;
                    }
                });

                if (updated) {
                    saveBoardToFirestore();
                    renderBoard();
                    checkForBingo();
                } else {
                    renderBoard(); // 대기 상태 등 시각적 업데이트
                }
            }, (error) => {
                console.error("Submission listener error:", error);
            });
        }

        /**
         * 배열을 섞는 Fisher-Yates 알고리즘
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * 사용자의 정답을 검사하기 위해 문자열을 정규화합니다.
         */
        function normalizeAnswer(str) {
            return str.replace(/\s+/g, '').toLowerCase();
        }

        /**
         * 빙고판의 HTML 요소를 생성하고 렌더링합니다.
         */
        function renderBoard() {
            if (!gridElement) return; // 요소가 없으면 실행 중단

            gridElement.innerHTML = '';
            board.forEach((item, index) => {
                const cell = document.createElement('div');
                cell.className = `bingo-cell p-3 flex flex-col justify-center items-center font-semibold text-center transition duration-300`;
                
                let currentStatus = item.isFilled ? 'filled' : (item.isActionMission ? submissionStates[index] : null);

                if (currentStatus === 'filled') {
                    // 채워진 칸 스타일 (정답 혹은 보너스/승인 완료)
                    const isBonus = item.topic.includes('보너스');
                    const answerDisplay = isBonus ? '보너스 획득' : (item.isActionMission ? '미션 완료' : (item.answer[0] || ''));
                    cell.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'shadow-inner', 'cursor-default');
                    cell.innerHTML = `
                        <span class="text-3xl mb-1">${isBonus ? '⭐' : '✅'}</span>
                        <p class="text-sm font-bold">${answerDisplay}</p>
                        <p class="text-xs text-gray-600 mt-1 opacity-70">${item.topic}</p>
                    `;
                    cell.onclick = () => showCellInfo(item, index, currentStatus);
                } else if (currentStatus === 'pending') {
                    // 인증 대기 중
                    cell.classList.add('status-pending', 'border-orange-500', 'text-orange-700', 'shadow-md');
                    cell.innerHTML = `
                        <span class="text-3xl mb-1">⏳</span>
                        <p class="text-sm font-bold">인증 대기 중</p>
                        <p class="text-xs text-orange-600 mt-1">${item.topic}</p>
                    `;
                    cell.onclick = () => showCellInfo(item, index, currentStatus);
                } else {
                    // 안 채워진 칸 스타일 (문제)
                    cell.classList.add('bg-white', 'border-gray-400', 'text-gray-800', 'hover:border-yellow-500');
                    cell.innerHTML = `<span class="text-base md:text-lg leading-snug font-bold text-red-700">${item.topic}</span><p class="text-xs mt-1 text-gray-500">클릭하여 문제 확인</p>`;
                    cell.onclick = () => selectCell(index);
                }

                if (index === selectedIndex) {
                    // 선택된 칸 하이라이트
                    cell.classList.add('ring-4', 'ring-offset-4', 'ring-yellow-500', 'scale-[1.05]', 'z-10');
                    cell.classList.remove('box-shadow', 'transform');
                }

                gridElement.appendChild(cell);
            });
        }

        /**
         * 셀을 선택했을 때 UI를 업데이트합니다.
         */
        function selectCell(index) {
            const item = board[index];
            const currentStatus = item.isActionMission ? submissionStates[index] : null;

            if (item.isFilled || currentStatus === 'pending') {
                showCellInfo(item, index, currentStatus);
                return;
            }

            selectedIndex = index;
            renderBoard();

            currentQuestionTitle.textContent = `미션 #${index + 1}: ${item.topic}`;
            currentQuestionText.textContent = item.question;
            
            // 액션 패널 활성화 스타일
            actionPanel.classList.add('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.remove('bg-[#FDF8F8]');
            
            // 미션 타입에 따라 입력 UI 변경
            if (item.isActionMission) {
                // 인증 미션: '인증 요청' 버튼 활성화
                inputElement.classList.add('hidden');
                submitButton.classList.add('hidden');
                submitActionButton.classList.remove('hidden');
                // Firebase 연결이 없으면 인증 요청 버튼 비활성화
                submitActionButton.disabled = !db;
                if (!db) {
                     submitActionButton.title = 'Firebase 연결이 필요합니다.';
                } else {
                     submitActionButton.title = '';
                }

            } else {
                // 일반 미션: '정답 입력' UI 활성화
                inputElement.classList.remove('hidden');
                submitButton.classList.remove('hidden');
                submitActionButton.classList.add('hidden');
                inputElement.value = '';
                inputElement.disabled = false;
                submitButton.disabled = false;
                inputElement.focus();
            }
        }

        /**
         * 채워지거나 대기 중인 셀의 정보를 표시합니다.
         */
        function showCellInfo(item, index, status) {
            selectedIndex = index;
            renderBoard();
            
            const isBonus = item.topic.includes('보너스');

            if (isBonus) {
                currentQuestionTitle.textContent = "⭐ 보너스 획득 (자동 완료)";
                currentQuestionText.textContent = "이 칸은 시작과 동시에 자동으로 채워진 보너스 칸입니다.";
            } else if (status === 'filled') {
                currentQuestionTitle.textContent = `✅ 미션 완료 (#${index + 1})`;
                currentQuestionText.textContent = item.isActionMission ? "액션 미션 완료! 관리자 승인 완료됨." : `정답: "${item.answer[0]}" (훌륭합니다!)`;
            } else if (status === 'pending') {
                currentQuestionTitle.textContent = `⏳ 인증 대기 중 (#${index + 1})`;
                currentQuestionText.textContent = "인증 요청이 관리자에게 전송되었습니다. 잠시 후 확인해 주세요.";
            }

            // 모든 입력/액션 버튼 비활성화
            inputElement.classList.add('hidden');
            submitButton.classList.add('hidden');
            submitActionButton.classList.add('hidden');
            
            actionPanel.classList.remove('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.add('bg-[#FDF8F8]');
            
            renderBoard();
        }

        /**
         * 일반 미션 정답 확인 및 보드 업데이트
         */
        function checkAnswer() {
            if (selectedIndex === -1 || board[selectedIndex].isFilled) return;

            const item = board[selectedIndex];
            const userInput = normalizeAnswer(inputElement.value);
            const correctAnswers = item.answer.map(normalizeAnswer);

            if (correctAnswers.some(correct => correct === userInput) && userInput !== "") {
                board[selectedIndex].isFilled = true;
                saveBoardToFirestore();
                statusMessage.textContent = '🎉 정답입니다! 해당 칸이 채워졌습니다.';
                renderBoard();
                setTimeout(checkForBingo, 500);
            } else {
                statusMessage.textContent = '❌ 오답입니다. 정답을 다시 생각해 보세요!';
                inputElement.focus();
            }
        }
        
        /**
         * 액션 미션 인증 요청을 Firestore에 기록
         */
        async function submitPhotoRequest() {
            if (!db) {
                alert('❌ Firebase 연결이 필요합니다. 로컬 환경에서는 인증 요청을 보낼 수 없습니다.');
                return;
            }

            if (selectedIndex === -1 || board[selectedIndex].isFilled || submissionStates[selectedIndex] === 'pending') return;
            if (!userId) {
                statusMessage.textContent = '사용자 인증 중입니다. 잠시 기다려주세요.';
                return;
            }

            const userName = userNameInput.value.trim();
            if (userName === "") {
                statusMessage.textContent = '❌ 이름 또는 팀명을 먼저 입력해 주세요!';
                userNameInput.focus();
                return;
            }

            const item = board[selectedIndex];
            try {
                // 컬렉션 경로 변경: 'submissions_opera'
                const submissionRef = doc(db, `artifacts/${appId}/public/submissions_opera`, `${userId}_${selectedIndex}`);
                await setDoc(submissionRef, {
                    userId: userId,
                    userName: userName, // 사용자 이름 추가
                    missionIndex: selectedIndex,
                    topic: item.topic,
                    question: item.question,
                    status: 'pending',
                    requestTime: new Date()
                });
                
                // 로컬 상태 업데이트
                submissionStates[selectedIndex] = 'pending';
                statusMessage.textContent = '⏳ 인증 요청이 관리자에게 전송되었습니다. 승인 대기 중...';
                
                showCellInfo(item, selectedIndex, 'pending'); // UI 업데이트
                renderBoard();

            } catch (error) {
                console.error("Submission request failed:", error);
                statusMessage.textContent = '❌ 인증 요청 전송 실패! 네트워크를 확인하세요.';
            }
        }

        /**
         * 현재 상태에서 빙고 완성 여부를 확인합니다.
         */
        function checkForBingo() {
            const size = GRID_SIZE;
            let bingoCount = 0;
            // 행 체크
            for (let i = 0; i < size; i++) {
                let rowFilled = true;
                for (let j = 0; j < size; j++) { if (!board[i * size + j].isFilled) { rowFilled = false; break; } }
                if (rowFilled) bingoCount++;
            }
            // 열 체크
            for (let j = 0; j < size; j++) {
                let colFilled = true;
                for (let i = 0; i < size; i++) { if (!board[i * size + j].isFilled) { colFilled = false; break; } }
                if (colFilled) bingoCount++;
            }
            // 대각선 1 (\) 체크
            let diag1Filled = true;
            for (let i = 0; i < size; i++) { if (!board[i * size + i].isFilled) { diag1Filled = false; break; } }
            if (diag1Filled) bingoCount++;
            // 대각선 2 (/) 체크
            let diag2Filled = true;
            for (let i = 0; i < size; i++) { if (!board[i * size + (size - 1 - i)].isFilled) { diag2Filled = false; break; } }
            if (diag2Filled) bingoCount++;

            if (bingoCount > 0) {
                showWinMessage(bingoCount);
            } else {
                statusMessage.textContent = `현재 ${board.filter(item => item.isFilled).length}칸 채움. 빙고를 위해 집중하세요! 사용자 ID: ${db ? userId : '로컬'}`;
                resetControls();
            }
        }

        /**
         * UI 초기 상태로 되돌립니다.
         */
        function resetControls() {
            selectedIndex = -1;
            currentQuestionTitle.textContent = '✅ 미션 선택 대기 중';
            currentQuestionText.textContent = '빙고판의 문제를 터치하여 미션을 시작해 주세요.';
            
            // 모든 입력/액션 버튼 숨기기
            inputElement.classList.remove('hidden'); 
            submitButton.classList.remove('hidden'); 
            submitActionButton.classList.add('hidden'); 

            inputElement.value = '';
            inputElement.disabled = true;
            submitButton.disabled = true;
            
            actionPanel.classList.remove('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.add('bg-[#FDF8F8]');
            
            renderBoard();
        }

        /**
         * 빙고 승리 메시지를 표시합니다.
         */
        function showWinMessage(count) {
            statusMessage.textContent = `대단해요! 총 ${count}줄의 빙고를 완성했습니다!`;
            winModal.classList.remove('hidden');
            winModal.classList.add('flex');
            
            const confettiColors = ['#ffcc00', '#b91c1c', '#4CAF50', '#ef4444'];
            for (let i = 0; i < 70; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -100}px`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animation = `confetti ${1.5 + Math.random() * 1.5}s ease-out forwards`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        /**
         * 모든 이벤트 리스너를 한 곳에 모아 설정합니다.
         */
        function attachEventListeners() {
            submitButton.addEventListener('click', checkAnswer);
            submitActionButton.addEventListener('click', submitPhotoRequest);
            inputElement.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !submitButton.disabled) {
                    checkAnswer();
                }
            });
            closeModalButton.addEventListener('click', () => {
                winModal.classList.add('hidden');
                winModal.classList.remove('flex');
            });
            resetButton.addEventListener('click', async () => {
                if (confirm("게임을 다시 시작하시겠습니까? 현재 진행 상황은 초기화됩니다.")) {
                    initializeNewBoard();
                    submissionStates = {};
                    statusMessage.textContent = '게임이 초기화되었습니다. 다시 시작하세요!';
                }
            });
        }

        // --- 초기 실행 ---
        window.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences(); // DOM 요소 할당 (가장 중요)
            attachEventListeners(); 
            setupFirebaseAndListen();
        });
    </script>
</body>
</html>
