<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ë“± ì˜¤í˜ë¼ ë¹™ê³  í•™ìŠµ (3x3)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard í°íŠ¸ ë¡œë“œ (êµìœ¡ìš©ìœ¼ë¡œ ì¸ê¸°, ê³ ê°€ë…ì„±) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fcf8f3; /* ì˜¤í˜ë¼ ë°°ê²½ìƒ‰ */
        }
        .app-container {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0b4b4; 
            background-color: #fcfcfc;
        }
        .bingo-grid {
            grid-template-columns: repeat(3, 1fr); /* 3x3 ê·¸ë¦¬ë“œ */
            transform: perspective(1000px) rotateX(1deg);
        }
        .bingo-cell {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-height: 120px;
            border-radius: 12px;
            border: 2px solid #ccc;
            word-break: keep-all; 
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
        }
        .bingo-cell:not(.bg-green-100):hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .bingo-cell.bg-green-100 {
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.15), 0 0 0 4px #4ade80;
            background: linear-gradient(145deg, #d4edda, #c6e9d2);
            transform: none;
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #ffcc00; 
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }
        .action-panel-active {
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3); /* ë¶‰ì€ìƒ‰ ê³„ì—´ ê°•ì¡° */
            transform: translateY(-5px);
            border-color: #b91c1c;
        }
        #submit-answer, #submit-action, #reset-game {
            transform: translateY(0);
            box-shadow: 0 4px 0 0 #991b1b; /* ì§„í•œ ë¶‰ì€ìƒ‰ */
            transition: all 0.1s ease;
        }
        #submit-answer:active, #submit-action:active, #reset-game:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 0 #991b1b;
        }
        #submit-answer:disabled, #submit-action:disabled {
            box-shadow: none;
        }
        /* ì¸ì¦ ëŒ€ê¸° ì¤‘ ì…€ ìŠ¤íƒ€ì¼ */
        .bingo-cell.status-pending {
            background-color: #ffeecf;
            border-color: #fca5a5;
            color: #d97706;
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(251, 146, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-xl mx-auto app-container rounded-2xl p-6 md:p-10 border-t-8 border-red-700">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-red-700 mb-2">
                ğŸ­ ì˜¤í˜ë¼ í•µì‹¬ ê°œë…<br> 3x3 ë¹™ê³  í€´ì¦ˆ
            </h1>
            <p class="text-lg text-gray-600">
                ê³ ë“±í•™êµ ìŒì•… ìˆ˜ì—… (ì˜¤í˜ë¼ì˜ ì´í•´)
            </p>
        </header>

        <!-- ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ë° ìƒíƒœ ë©”ì‹œì§€ -->
        <div class="mb-4">
            <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-1">íŒ€/í•™ìƒ ì´ë¦„ ì…ë ¥ (í•„ìˆ˜)</label>
            <input type="text" id="user-name-input" placeholder="ì´ë¦„ ë˜ëŠ” íŒ€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                   class="w-full p-2 border-2 border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-base"
                   oninput="localStorage.setItem('bingo_user_name_opera', this.value);">
        </div>
        
        <div id="status-message" class="text-center mb-6 h-10">
            <p class="text-xl font-semibold text-gray-700">ë¹™ê³ íŒì„ ì™„ì„±í•´ ë³´ì„¸ìš”! ì‚¬ìš©ì ID: <span id="user-id-display" class="font-mono text-sm text-gray-500"></span></p>
        </div>

        <!-- ë¹™ê³  ê·¸ë¦¬ë“œ -->
        <div id="bingo-grid" class="bingo-grid grid gap-3 md:gap-4 w-full aspect-square">
            <!-- Cell content will be generated by JavaScript -->
        </div>

        <!-- ì§ˆë¬¸/ì•¡ì…˜ íŒ¨ë„ -->
        <div id="action-panel" class="mt-8 bg-[#FDF8F8] p-4 md:p-6 rounded-xl border border-gray-200 transition duration-300">
            <h2 class="text-2xl font-extrabold text-red-700 mb-2" id="current-question-title">
                âœ… ë¯¸ì…˜ ì„ íƒ ëŒ€ê¸° ì¤‘
            </h2>
            <p class="text-lg text-gray-700 mb-4" id="current-question-text">
                ë¹™ê³ íŒì˜ ë¬¸ì œë¥¼ í„°ì¹˜í•˜ì—¬ ë¯¸ì…˜ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.
            </p>

            <div id="input-container" class="flex flex-col sm:flex-row gap-3">
                <!-- ì¼ë°˜ ì •ë‹µ ì…ë ¥ UI (ê¸°ë³¸) -->
                <input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•„ë¦¬ì•„)"
                       class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-500 text-lg disabled:bg-gray-100"
                       aria-label="ì •ë‹µ ì…ë ¥ í•„ë“œ">
                <button id="submit-answer"
                        class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ì •ë‹µ í™•ì¸
                </button>
                
                <!-- ì¸ì¦ ë¯¸ì…˜ ì „ìš© UI (ìˆ¨ê¹€) -->
                <button id="submit-action"
                        class="hidden w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ğŸ“¸ ìœ ëª… ì˜¤í˜ë¼ ì¸ì¦ ìš”ì²­ (ê´€ë¦¬ì í™•ì¸ í•„ìš”)
                </button>
            </div>
            
            <button id="reset-game"
                    class="mt-4 w-full px-6 py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-200">
                ê²Œì„ ì¬ì‹œì‘
            </button>
        </div>
    </div>

    <!-- ë¹™ê³  ìŠ¹ë¦¬ ëª¨ë‹¬ -->
    <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full animate-in zoom-in duration-500">
            <h3 class="text-4xl font-extrabold text-green-600 mb-4">ğŸ‰ ë¹™ê³  ì„±ê³µ! ğŸ†</h3>
            <p class="text-xl text-gray-700 mb-6">
                ì˜¤í˜ë¼ í€´ì¦ˆ ë¹™ê³ ë¥¼ ì™„ì„±í–ˆì–´ìš”! í›Œë¥­í•©ë‹ˆë‹¤.
            </p>
            <button id="close-modal" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200">
                ë‹«ê¸°
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase ì´ˆê¸°í™” ë° ì„¤ì • (ë¡œì»¬ í™˜ê²½ ëŒ€ì‘) ---
        // Canvas ì™¸ í™˜ê²½ì—ì„œ ì‹¤í–‰ë  ê²½ìš°, ì•„ë˜ì™€ ê°™ì´ ë”ë¯¸ ê°’ ì‚¬ìš©ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'local-debug-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = '';
        const GRID_SIZE = 3;

        try {
            // ë¡œì»¬ ë””ë²„ê¹… í™˜ê²½(firebaseConfigê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°)ì¸ì§€ í™•ì¸
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("--- LOCAL ENVIRONMENT WARNING (Student App) ---");
                console.error("Firebase config is empty. Bingo progress will NOT be saved/shared.");
                document.getElementById('status-message').querySelector('p').textContent = 'âš ï¸ ë¡œì»¬ í™˜ê²½ ì‹¤í–‰ ì¤‘. Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                // Firebase ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆë›°ê³  ê¸°ëŠ¥ ë¹„í™œì„±í™” (db, authëŠ” undefined ìƒíƒœ ìœ ì§€)
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            }
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('status-message').querySelector('p').textContent = 'âŒ Firebase ì—°ê²° ì˜¤ë¥˜. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
        }

        // --- DOM ìš”ì†Œ ë³€ìˆ˜ ì„ ì–¸ ---
        let gridElement, statusMessage, actionPanel, inputContainer, inputElement, submitButton, submitActionButton, currentQuestionTitle, currentQuestionText, winModal, closeModalButton, resetButton, userNameInput;

        // --- DOM ìš”ì†Œ í• ë‹¹ í•¨ìˆ˜ (DOMContentLoaded ì´í›„ í˜¸ì¶œ) ---
        function initializeDOMReferences() {
            gridElement = document.getElementById('bingo-grid');
            statusMessage = document.getElementById('status-message').querySelector('p');
            actionPanel = document.getElementById('action-panel');
            inputContainer = document.getElementById('input-container');
            inputElement = document.getElementById('answer-input');
            submitButton = document.getElementById('submit-answer');
            submitActionButton = document.getElementById('submit-action');
            currentQuestionTitle = document.getElementById('current-question-title');
            currentQuestionText = document.getElementById('current-question-text');
            winModal = document.getElementById('win-modal');
            closeModalButton = document.getElementById('close-modal');
            resetButton = document.getElementById('reset-game');
            userNameInput = document.getElementById('user-name-input');
            
            // ì €ì¥ëœ ì´ë¦„ ë¡œë“œ
            const savedName = localStorage.getItem('bingo_user_name_opera');
            if (savedName) {
                userNameInput.value = savedName;
            }
        }

        /**
         * Firebase ì¸ì¦ ë° ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         */
        async function setupFirebaseAndListen() {
            // Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´, ë³´ë“œë§Œ ìƒì„±í•˜ê³  ì¢…ë£Œ
            if (!db) {
                initializeNewBoard();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    await loadOrCreateBoard();
                    listenForSubmissions(); // ì‹¤ì‹œê°„ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        document.getElementById('status-message').querySelector('p').textContent = 'âŒ ì¸ì¦ ì˜¤ë¥˜ ë°œìƒ.';
                    }
                }
            });
        }
        
        // --- ê²Œì„ ë°ì´í„° ì •ì˜ ë° ìƒíƒœ ê´€ë¦¬ ---

        const BINGO_ITEMS = [
            { topic: "ì£¼ìš” ë…ì°½", question: "ì˜¤í˜ë¼ì—ì„œ ê°ì •ì„ í­ë°œì‹œí‚¤ë©° ë¶€ë¥´ëŠ”, ê¸°êµë¥¼ ì¤‘ì‹œí•œ 'ì£¼ìš” ë…ì°½ê³¡'ì€? (ì´íƒˆë¦¬ì•„ì–´)", answer: ["ì•„ë¦¬ì•„"], isActionMission: false },
            { topic: "ì˜¤í˜ë¼ ëŒ€ë³¸", question: "ì˜¤í˜ë¼ì˜ ë‚´ìš©ì„ ë‹´ê³  ìˆëŠ” 'ê°€ì‚¬ ëŒ€ë³¸'ì„ ëœ»í•˜ëŠ” ì´íƒˆë¦¬ì•„ì–´ëŠ”?", answer: ["ë¦¬ë¸Œë ˆí† "], isActionMission: false },
            { topic: "ì˜¤í˜ë¼ì˜ ì„œê³¡", question: "ì˜¤ì¼€ìŠ¤íŠ¸ë¼ê°€ ì—°ì£¼í•˜ëŠ” ì˜¤í˜ë¼ ì‹œì‘ ì „ì˜ 'ì„œê³¡'ì€?", answer: ["ì˜¤ë²„ì¶”ì–´"], isActionMission: false },
            { topic: "ê·¹ ì§„í–‰ ëŒ€í™”", question: "ê·¹ì˜ ì¤„ê±°ë¦¬ ì§„í–‰ì„ ìœ„í•´ ëŒ€í™”ì²˜ëŸ¼ ë…¸ë˜í•˜ëŠ” ë¶€ë¶„(ì„ ìœ¨ì´ ë‹¨ìˆœí•¨)ì€?", answer: ["ë ˆì¹˜íƒ€í‹°ë³´"], isActionMission: false },
            
            // ì¤‘ì•™ ë³´ë„ˆìŠ¤ (Index 4)
            { topic: "ğŸŒŸ ë³´ë„ˆìŠ¤ ì°¬ìŠ¤ ğŸŒŸ", question: "ğŸŒŸ ë³´ë„ˆìŠ¤ ì°¬ìŠ¤ ğŸŒŸ", answer: ["ë³´ë„ˆìŠ¤"], isFilled: true, isActionMission: false }, 
            
            { topic: "ë‚¨ì„± ìµœê³  ìŒì—­", question: "ì˜¤í˜ë¼ì—ì„œ ê°€ì¥ ë†’ì€ ìŒì—­ëŒ€ë¥¼ ë§¡ìœ¼ë©°, ì£¼ë¡œ ì˜ì›…ì´ë‚˜ ì£¼ì¸ê³µ ì—­í• ì„ í•˜ëŠ” ë‚¨ì„± ê°€ìˆ˜ëŠ”?", answer: ["í…Œë„ˆ"], isActionMission: false },
            { topic: "êµ°ì¤‘ í•©ì°½", question: "ì˜¤í˜ë¼ì—ì„œ ë°°ê²½ì„ ì„¤ëª…í•˜ê±°ë‚˜ êµ°ì¤‘ì˜ ê°ì •ì„ í‘œí˜„í•˜ëŠ” 'í•©ì°½ë‹¨'ì€?", answer: ["ì½”ëŸ¬ìŠ¤", "í•©ì°½"], isActionMission: false },
            
            // ë¯¸ì…˜: ì˜¤í˜ë¼ ê°ìƒ ì¸ì¦ (ì•¡ì…˜ ë¯¸ì…˜)
            { topic: "ğŸ“¸ ìœ ëª… ì˜¤í˜ë¼ ì¸ì¦", question: "ìˆ˜ì—…ì—ì„œ ë°°ìš´ ìœ ëª… ì˜¤í˜ë¼ ì‘í’ˆ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê³ , ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì¥ë©´ì´ë‚˜ ë“±ì¥ì¸ë¬¼ì„ ì„¤ëª…í•˜ì—¬ ì¸ì¦ ìš”ì²­ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”. (ì˜ˆ: 'ì¹´ë¥´ë©˜'ì˜ íˆ¬ìš°ì‚¬)", answer: ["ì¸ì¦"], isActionMission: true }, 
            
            { topic: "ì˜¤í˜ë¼ì˜ íƒ„ìƒêµ­", question: "16ì„¸ê¸° ë§~17ì„¸ê¸° ì´ˆ, ì˜¤í˜ë¼ê°€ ì²˜ìŒ íƒ„ìƒí•œ ìœ ëŸ½ì˜ ë‚˜ë¼ëŠ”?", answer: ["ì´íƒˆë¦¬ì•„"], isActionMission: false }
        ];

        let board = [];
        let selectedIndex = -1;
        let submissionStates = {}; 


        /**
         * Firestoreì— ì €ì¥ëœ ì‚¬ìš©ì ë³´ë“œë¥¼ ë¡œë“œí•˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
         */
        async function loadOrCreateBoard() {
            // Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìƒˆ ë³´ë“œ ìƒì„± í›„ ì¢…ë£Œ
            if (!db) {
                initializeNewBoard();
                return;
            }
            if (!userId) return;

            // ì»¬ë ‰ì…˜ ê²½ë¡œ ë³€ê²½: 'current_board_opera'
            const boardRef = doc(db, `artifacts/${appId}/users/${userId}/bingo_data`, 'current_board_opera');
            const dataSnapshot = await getDoc(boardRef);

            if (dataSnapshot.exists()) {
                board = JSON.parse(dataSnapshot.data().state);
                statusMessage.textContent = 'ì €ì¥ëœ ë¹™ê³ íŒì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.';
            } else {
                initializeNewBoard();
            }
            renderBoard();
        }

        /**
         * ìƒˆë¡œìš´ ë¹™ê³  ë³´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function initializeNewBoard() {
            let shuffledItems = shuffleArray([...BINGO_ITEMS]);
            
            board = [];
            for (let i = 0; i < 9; i++) {
                const item = shuffledItems[i];
                board.push({ ...item, isFilled: item.topic.includes('ë³´ë„ˆìŠ¤') ? true : false, submissionStatus: null, id: crypto.randomUUID() });
            }
            saveBoardToFirestore();
            statusMessage.textContent = db ? 'ìƒˆë¡œìš´ ë¹™ê³ íŒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'âš ï¸ ë¡œì»¬ ë³´ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì €ì¥ ë¶ˆê°€)';
        }
        
        /**
         * í˜„ì¬ ë³´ë“œ ìƒíƒœë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        async function saveBoardToFirestore() {
            if (!db) return; // Firebase ì—°ê²°ì´ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
            if (!userId) return;
            try {
                // ì»¬ë ‰ì…˜ ê²½ë¡œ ë³€ê²½: 'current_board_opera'
                const boardRef = doc(db, `artifacts/${appId}/users/${userId}/bingo_data`, 'current_board_opera');
                await setDoc(boardRef, {
                    state: JSON.stringify(board),
                    updatedAt: new Date(),
                    userId: userId
                });
            } catch (error) {
                console.error("Failed to save board:", error);
                statusMessage.textContent = 'âŒ ë¹™ê³ íŒ ì €ì¥ ì‹¤íŒ¨!';
            }
        }

        /**
         * ì‹¤ì‹œê°„ ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ê´€ë¦¬ì ìŠ¹ì¸ í™•ì¸ìš©)
         */
        function listenForSubmissions() {
            if (!db) return; // Firebase ì—°ê²°ì´ ì—†ìœ¼ë©´ ë¦¬ìŠ¤ë„ˆ ì‘ë™ ì•ˆí•¨
            if (!userId) return;
            // ì»¬ë ‰ì…˜ ê²½ë¡œ ë³€ê²½: 'submissions_opera'
            const submissionsRef = collection(db, `artifacts/${appId}/public/submissions_opera`);
            const userQuery = query(submissionsRef, where("userId", "==", userId));

            onSnapshot(userQuery, (snapshot) => {
                let updated = false;
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const missionIndex = data.missionIndex;
                    
                    submissionStates[missionIndex] = data.status; // ìƒíƒœ ì—…ë°ì´íŠ¸

                    // ìƒíƒœê°€ 'approved'ë¡œ ë³€ê²½ë˜ì—ˆê³ , ì•„ì§ ë¹™ê³ íŒì— ë°˜ì˜ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë°˜ì˜
                    if (data.status === 'approved' && !board[missionIndex].isFilled) {
                        board[missionIndex].isFilled = true;
                        statusMessage.textContent = `ğŸ‰ ê´€ë¦¬ìê°€ ë¯¸ì…˜ #${missionIndex + 1}ì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤!`;
                        updated = true;
                    }
                });

                if (updated) {
                    saveBoardToFirestore();
                    renderBoard();
                    checkForBingo();
                } else {
                    renderBoard(); // ëŒ€ê¸° ìƒíƒœ ë“± ì‹œê°ì  ì—…ë°ì´íŠ¸
                }
            }, (error) => {
                console.error("Submission listener error:", error);
            });
        }

        /**
         * ë°°ì—´ì„ ì„ëŠ” Fisher-Yates ì•Œê³ ë¦¬ì¦˜
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * ì‚¬ìš©ìì˜ ì •ë‹µì„ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ë¬¸ìì—´ì„ ì •ê·œí™”í•©ë‹ˆë‹¤.
         */
        function normalizeAnswer(str) {
            return str.replace(/\s+/g, '').toLowerCase();
        }

        /**
         * ë¹™ê³ íŒì˜ HTML ìš”ì†Œë¥¼ ìƒì„±í•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderBoard() {
            if (!gridElement) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

            gridElement.innerHTML = '';
            board.forEach((item, index) => {
                const cell = document.createElement('div');
                cell.className = `bingo-cell p-3 flex flex-col justify-center items-center font-semibold text-center transition duration-300`;
                
                let currentStatus = item.isFilled ? 'filled' : (item.isActionMission ? submissionStates[index] : null);

                if (currentStatus === 'filled') {
                    // ì±„ì›Œì§„ ì¹¸ ìŠ¤íƒ€ì¼ (ì •ë‹µ í˜¹ì€ ë³´ë„ˆìŠ¤/ìŠ¹ì¸ ì™„ë£Œ)
                    const isBonus = item.topic.includes('ë³´ë„ˆìŠ¤');
                    const answerDisplay = isBonus ? 'ë³´ë„ˆìŠ¤ íšë“' : (item.isActionMission ? 'ë¯¸ì…˜ ì™„ë£Œ' : (item.answer[0] || ''));
                    cell.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'shadow-inner', 'cursor-default');
                    cell.innerHTML = `
                        <span class="text-3xl mb-1">${isBonus ? 'â­' : 'âœ…'}</span>
                        <p class="text-sm font-bold">${answerDisplay}</p>
                        <p class="text-xs text-gray-600 mt-1 opacity-70">${item.topic}</p>
                    `;
                    cell.onclick = () => showCellInfo(item, index, currentStatus);
                } else if (currentStatus === 'pending') {
                    // ì¸ì¦ ëŒ€ê¸° ì¤‘
                    cell.classList.add('status-pending', 'border-orange-500', 'text-orange-700', 'shadow-md');
                    cell.innerHTML = `
                        <span class="text-3xl mb-1">â³</span>
                        <p class="text-sm font-bold">ì¸ì¦ ëŒ€ê¸° ì¤‘</p>
                        <p class="text-xs text-orange-600 mt-1">${item.topic}</p>
                    `;
                    cell.onclick = () => showCellInfo(item, index, currentStatus);
                } else {
                    // ì•ˆ ì±„ì›Œì§„ ì¹¸ ìŠ¤íƒ€ì¼ (ë¬¸ì œ)
                    cell.classList.add('bg-white', 'border-gray-400', 'text-gray-800', 'hover:border-yellow-500');
                    cell.innerHTML = `<span class="text-base md:text-lg leading-snug font-bold text-red-700">${item.topic}</span><p class="text-xs mt-1 text-gray-500">í´ë¦­í•˜ì—¬ ë¬¸ì œ í™•ì¸</p>`;
                    cell.onclick = () => selectCell(index);
                }

                if (index === selectedIndex) {
                    // ì„ íƒëœ ì¹¸ í•˜ì´ë¼ì´íŠ¸
                    cell.classList.add('ring-4', 'ring-offset-4', 'ring-yellow-500', 'scale-[1.05]', 'z-10');
                    cell.classList.remove('box-shadow', 'transform');
                }

                gridElement.appendChild(cell);
            });
        }

        /**
         * ì…€ì„ ì„ íƒí–ˆì„ ë•Œ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function selectCell(index) {
            const item = board[index];
            const currentStatus = item.isActionMission ? submissionStates[index] : null;

            if (item.isFilled || currentStatus === 'pending') {
                showCellInfo(item, index, currentStatus);
                return;
            }

            selectedIndex = index;
            renderBoard();

            currentQuestionTitle.textContent = `ë¯¸ì…˜ #${index + 1}: ${item.topic}`;
            currentQuestionText.textContent = item.question;
            
            // ì•¡ì…˜ íŒ¨ë„ í™œì„±í™” ìŠ¤íƒ€ì¼
            actionPanel.classList.add('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.remove('bg-[#FDF8F8]');
            
            // ë¯¸ì…˜ íƒ€ì…ì— ë”°ë¼ ì…ë ¥ UI ë³€ê²½
            if (item.isActionMission) {
                // ì¸ì¦ ë¯¸ì…˜: 'ì¸ì¦ ìš”ì²­' ë²„íŠ¼ í™œì„±í™”
                inputElement.classList.add('hidden');
                submitButton.classList.add('hidden');
                submitActionButton.classList.remove('hidden');
                // Firebase ì—°ê²°ì´ ì—†ìœ¼ë©´ ì¸ì¦ ìš”ì²­ ë²„íŠ¼ ë¹„í™œì„±í™”
                submitActionButton.disabled = !db;
                if (!db) {
                     submitActionButton.title = 'Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                } else {
                     submitActionButton.title = '';
                }

            } else {
                // ì¼ë°˜ ë¯¸ì…˜: 'ì •ë‹µ ì…ë ¥' UI í™œì„±í™”
                inputElement.classList.remove('hidden');
                submitButton.classList.remove('hidden');
                submitActionButton.classList.add('hidden');
                inputElement.value = '';
                inputElement.disabled = false;
                submitButton.disabled = false;
                inputElement.focus();
            }
        }

        /**
         * ì±„ì›Œì§€ê±°ë‚˜ ëŒ€ê¸° ì¤‘ì¸ ì…€ì˜ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showCellInfo(item, index, status) {
            selectedIndex = index;
            renderBoard();
            
            const isBonus = item.topic.includes('ë³´ë„ˆìŠ¤');

            if (isBonus) {
                currentQuestionTitle.textContent = "â­ ë³´ë„ˆìŠ¤ íšë“ (ìë™ ì™„ë£Œ)";
                currentQuestionText.textContent = "ì´ ì¹¸ì€ ì‹œì‘ê³¼ ë™ì‹œì— ìë™ìœ¼ë¡œ ì±„ì›Œì§„ ë³´ë„ˆìŠ¤ ì¹¸ì…ë‹ˆë‹¤.";
            } else if (status === 'filled') {
                currentQuestionTitle.textContent = `âœ… ë¯¸ì…˜ ì™„ë£Œ (#${index + 1})`;
                currentQuestionText.textContent = item.isActionMission ? "ì•¡ì…˜ ë¯¸ì…˜ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ ì™„ë£Œë¨." : `ì •ë‹µ: "${item.answer[0]}" (í›Œë¥­í•©ë‹ˆë‹¤!)`;
            } else if (status === 'pending') {
                currentQuestionTitle.textContent = `â³ ì¸ì¦ ëŒ€ê¸° ì¤‘ (#${index + 1})`;
                currentQuestionText.textContent = "ì¸ì¦ ìš”ì²­ì´ ê´€ë¦¬ìì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
            }

            // ëª¨ë“  ì…ë ¥/ì•¡ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            inputElement.classList.add('hidden');
            submitButton.classList.add('hidden');
            submitActionButton.classList.add('hidden');
            
            actionPanel.classList.remove('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.add('bg-[#FDF8F8]');
            
            renderBoard();
        }

        /**
         * ì¼ë°˜ ë¯¸ì…˜ ì •ë‹µ í™•ì¸ ë° ë³´ë“œ ì—…ë°ì´íŠ¸
         */
        function checkAnswer() {
            if (selectedIndex === -1 || board[selectedIndex].isFilled) return;

            const item = board[selectedIndex];
            const userInput = normalizeAnswer(inputElement.value);
            const correctAnswers = item.answer.map(normalizeAnswer);

            if (correctAnswers.some(correct => correct === userInput) && userInput !== "") {
                board[selectedIndex].isFilled = true;
                saveBoardToFirestore();
                statusMessage.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! í•´ë‹¹ ì¹¸ì´ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.';
                renderBoard();
                setTimeout(checkForBingo, 500);
            } else {
                statusMessage.textContent = 'âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì„ ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”!';
                inputElement.focus();
            }
        }
        
        /**
         * ì•¡ì…˜ ë¯¸ì…˜ ì¸ì¦ ìš”ì²­ì„ Firestoreì— ê¸°ë¡
         */
        async function submitPhotoRequest() {
            if (!db) {
                alert('âŒ Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì¸ì¦ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (selectedIndex === -1 || board[selectedIndex].isFilled || submissionStates[selectedIndex] === 'pending') return;
            if (!userId) {
                statusMessage.textContent = 'ì‚¬ìš©ì ì¸ì¦ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
                return;
            }

            const userName = userNameInput.value.trim();
            if (userName === "") {
                statusMessage.textContent = 'âŒ ì´ë¦„ ë˜ëŠ” íŒ€ëª…ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”!';
                userNameInput.focus();
                return;
            }

            const item = board[selectedIndex];
            try {
                // ì»¬ë ‰ì…˜ ê²½ë¡œ ë³€ê²½: 'submissions_opera'
                const submissionRef = doc(db, `artifacts/${appId}/public/submissions_opera`, `${userId}_${selectedIndex}`);
                await setDoc(submissionRef, {
                    userId: userId,
                    userName: userName, // ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€
                    missionIndex: selectedIndex,
                    topic: item.topic,
                    question: item.question,
                    status: 'pending',
                    requestTime: new Date()
                });
                
                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                submissionStates[selectedIndex] = 'pending';
                statusMessage.textContent = 'â³ ì¸ì¦ ìš”ì²­ì´ ê´€ë¦¬ìì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ ëŒ€ê¸° ì¤‘...';
                
                showCellInfo(item, selectedIndex, 'pending'); // UI ì—…ë°ì´íŠ¸
                renderBoard();

            } catch (error) {
                console.error("Submission request failed:", error);
                statusMessage.textContent = 'âŒ ì¸ì¦ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨! ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            }
        }

        /**
         * í˜„ì¬ ìƒíƒœì—ì„œ ë¹™ê³  ì™„ì„± ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function checkForBingo() {
            const size = GRID_SIZE;
            let bingoCount = 0;
            // í–‰ ì²´í¬
            for (let i = 0; i < size; i++) {
                let rowFilled = true;
                for (let j = 0; j < size; j++) { if (!board[i * size + j].isFilled) { rowFilled = false; break; } }
                if (rowFilled) bingoCount++;
            }
            // ì—´ ì²´í¬
            for (let j = 0; j < size; j++) {
                let colFilled = true;
                for (let i = 0; i < size; i++) { if (!board[i * size + j].isFilled) { colFilled = false; break; } }
                if (colFilled) bingoCount++;
            }
            // ëŒ€ê°ì„  1 (\) ì²´í¬
            let diag1Filled = true;
            for (let i = 0; i < size; i++) { if (!board[i * size + i].isFilled) { diag1Filled = false; break; } }
            if (diag1Filled) bingoCount++;
            // ëŒ€ê°ì„  2 (/) ì²´í¬
            let diag2Filled = true;
            for (let i = 0; i < size; i++) { if (!board[i * size + (size - 1 - i)].isFilled) { diag2Filled = false; break; } }
            if (diag2Filled) bingoCount++;

            if (bingoCount > 0) {
                showWinMessage(bingoCount);
            } else {
                statusMessage.textContent = `í˜„ì¬ ${board.filter(item => item.isFilled).length}ì¹¸ ì±„ì›€. ë¹™ê³ ë¥¼ ìœ„í•´ ì§‘ì¤‘í•˜ì„¸ìš”! ì‚¬ìš©ì ID: ${db ? userId : 'ë¡œì»¬'}`;
                resetControls();
            }
        }

        /**
         * UI ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
         */
        function resetControls() {
            selectedIndex = -1;
            currentQuestionTitle.textContent = 'âœ… ë¯¸ì…˜ ì„ íƒ ëŒ€ê¸° ì¤‘';
            currentQuestionText.textContent = 'ë¹™ê³ íŒì˜ ë¬¸ì œë¥¼ í„°ì¹˜í•˜ì—¬ ë¯¸ì…˜ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.';
            
            // ëª¨ë“  ì…ë ¥/ì•¡ì…˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            inputElement.classList.remove('hidden'); 
            submitButton.classList.remove('hidden'); 
            submitActionButton.classList.add('hidden'); 

            inputElement.value = '';
            inputElement.disabled = true;
            submitButton.disabled = true;
            
            actionPanel.classList.remove('action-panel-active', 'bg-red-50', 'border-red-500');
            actionPanel.classList.add('bg-[#FDF8F8]');
            
            renderBoard();
        }

        /**
         * ë¹™ê³  ìŠ¹ë¦¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showWinMessage(count) {
            statusMessage.textContent = `ëŒ€ë‹¨í•´ìš”! ì´ ${count}ì¤„ì˜ ë¹™ê³ ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!`;
            winModal.classList.remove('hidden');
            winModal.classList.add('flex');
            
            const confettiColors = ['#ffcc00', '#b91c1c', '#4CAF50', '#ef4444'];
            for (let i = 0; i < 70; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -100}px`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animation = `confetti ${1.5 + Math.random() * 1.5}s ease-out forwards`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        /**
         * ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í•œ ê³³ì— ëª¨ì•„ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function attachEventListeners() {
            submitButton.addEventListener('click', checkAnswer);
            submitActionButton.addEventListener('click', submitPhotoRequest);
            inputElement.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !submitButton.disabled) {
                    checkAnswer();
                }
            });
            closeModalButton.addEventListener('click', () => {
                winModal.classList.add('hidden');
                winModal.classList.remove('flex');
            });
            resetButton.addEventListener('click', async () => {
                if (confirm("ê²Œì„ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì§„í–‰ ìƒí™©ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) {
                    initializeNewBoard();
                    submissionStates = {};
                    statusMessage.textContent = 'ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”!';
                }
            });
        }

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        window.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences(); // DOM ìš”ì†Œ í• ë‹¹ (ê°€ì¥ ì¤‘ìš”)
            attachEventListeners(); 
            setupFirebaseAndListen();
        });
    </script>
</body>
</html>
